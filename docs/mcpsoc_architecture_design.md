# MCPSoc系统架构设计

## 1. 整体架构设计

### 1.1 架构概述

MCPSoc（Model Context Protocol Security Operations Center）采用基于MCP协议的开放式、分层架构设计，实现AI驱动的智能安全运营。系统通过标准化的MCP接口，将各种安全工具封装为MCP Server，由中央MCP Host进行统一编排和管理。

### 1.2 架构原则

1. **开放性**: 基于MCP开放协议，支持任意第三方安全工具接入
2. **模块化**: 各组件松耦合，可独立部署和扩展  
3. **标准化**: 统一的数据格式和API接口，消除数据孤岛
4. **智能化**: AI驱动的威胁检测、分析和响应
5. **可扩展**: 支持水平扩展，满足大规模部署需求

## 2. 核心组件架构

### 2.1 MCP Host服务（中央协调器）

**职责**:
- 接收自然语言查询和SOC任务
- 任务分解和执行计划生成
- 跨域数据关联和综合分析
- 安全工作流编排和自动化响应

**技术实现**:
- 基于Go语言开发，提供高性能并发处理
- 集成多种LLM API（OpenAI、Anthropic Claude、本地模型）
- 实现MCP客户端连接管理
- 提供RESTful API和Web管理界面

**核心功能模块**:
- 自然语言处理和意图识别
- 任务规划和执行引擎
- 数据融合和关联分析
- 工作流编排引擎
- 威胁情报整合

### 2.2 MCPSoc Agent（智能代理组件）

**职责**:
- 提供大模型推理和决策能力
- 自动化威胁检测和分析
- 生成调查报告和响应建议
- 持续学习和模型优化

**技术特性**:
- 支持多种LLM API集成
- 本地模型部署支持（如Llama、ChatGLM）
- 向量化知识库和RAG系统
- 模型结果缓存和优化

### 2.3 MCP Client（连接器组件）

**职责**:
- 维护与各MCP Server的通信连接
- 协议转换和消息路由
- 连接状态监控和故障恢复
- 负载均衡和请求分发

**技术实现**:
- 基于JSON-RPC 2.0协议
- 支持Stdio和HTTP传输
- 连接池管理和复用
- 断线重连和健康检查

### 2.4 MCP Server框架（标准化封装层）

**设计理念**:
提供统一的MCP Server开发框架，简化安全工具的MCP化改造。

**框架特性**:
- 多语言SDK支持（Go、Python、Node.js）
- 标准化配置和部署
- 内置认证和授权机制
- 日志审计和监控

## 3. 数据源接入层设计

### 3.1 防火墙数据接入

**支持的防火墙**:
- pfSense/OPNsense
- FortiGate、Palo Alto Networks
- 开源防火墙（iptables、ufw）

**接入方式**:
- Syslog日志收集
- SNMP监控数据
- REST API调用
- 配置文件解析

**数据标准化**:
```json
{
  "timestamp": "2025-07-29T15:19:59Z",
  "source": "pfsense-fw-01",
  "event_type": "firewall_log",
  "action": "block",
  "src_ip": "192.168.1.100",
  "dst_ip": "10.0.0.1",
  "src_port": 12345,
  "dst_port": 80,
  "protocol": "tcp",
  "interface": "wan",
  "rule_id": "block_external_access"
}
```

### 3.2 WAF数据接入

**支持的WAF**:
- ModSecurity
- AWS WAF、Cloudflare WAF
- NGINX ModSecurity
- OpenWAF

**集成功能**:
- 攻击事件检测
- 规则匹配结果
- 性能监控数据
- 误报分析

### 3.3 杀毒软件接入

**支持的杀毒软件**:
- ClamAV
- Windows Defender
- 企业级EDR解决方案

**数据类型**:
- 病毒检测结果
- 文件扫描记录
- 实时防护事件
- 隔离和清理日志

### 3.4 威胁情报源接入

**威胁情报类型**:
- IOC指标（IP、域名、文件哈希）
- APT攻击情报
- 漏洞信息（CVE）
- 恶意软件分析报告

**数据格式支持**:
- STIX/TAXII 2.0标准
- MISP格式
- JSON威胁情报
- CSV/XML格式

**集成的威胁情报源**:
- VirusTotal
- AlienVault OTX
- MISP社区
- 自定义威胁情报源

## 4. SOC运营层设计

### 4.1 威胁检测规则引擎

**检测能力**:
- 基于规则的威胁检测
- 机器学习异常检测
- 行为分析检测
- 威胁情报匹配

**规则管理**:
- 内置威胁检测规则库
- 自定义规则编写
- 规则版本管理
- A/B测试和优化

**检测类型**:
- 网络攻击检测
- 恶意软件检测
- 数据泄露检测
- 内部威胁检测

### 4.2 安全事件关联分析

**关联分析能力**:
- 时间序列关联
- 地理位置关联
- 行为模式关联
- 威胁情报关联

**分析算法**:
- 图数据库关联分析
- 时间窗口关联
- 频率和统计分析
- 机器学习聚类

**关联结果**:
- 事件链重构
- 攻击路径分析
- 影响范围评估
- 风险等级评分

### 4.3 自动化响应编排（SOAR）

**响应类型**:
- 自动化遏制：IP封锁、账户禁用
- 证据收集：日志导出、镜像制作
- 通知告警：邮件、短信、即时通讯
- 工单创建：JIRA、ServiceNow集成

**编排能力**:
- 可视化工作流设计
- 条件分支和循环
- 人工确认节点
- 执行状态跟踪

**集成的SOAR工具**:
- n8n（无代码自动化）
- Shuffle（开源SOAR）
- 自研工作流引擎

### 4.4 应急响应工作流

**标准响应流程**:
1. 事件发现和分类
2. 初步影响评估
3. 遏制和隔离
4. 证据收集和分析
5. 清除和恢复
6. 经验总结和改进

**响应模板**:
- 恶意软件响应
- 数据泄露响应
- 拒绝服务攻击响应
- 内部威胁响应

## 5. 技术选型方案

### 5.1 后端技术栈

**主要技术选择: Go语言**

选择理由:
- 优秀的并发性能，支持高并发场景
- 快速的编译和执行速度
- 内置的网络和JSON处理能力
- 良好的系统编程特性
- 活跃的安全社区和生态

**辅助技术**:
- Python：数据分析和机器学习组件
- Node.js：前端和快速原型开发

### 5.2 数据存储方案

**时序数据库: TimescaleDB**
- 专为时间序列数据优化
- 兼容PostgreSQL生态
- 优秀的查询性能
- 数据压缩和分区支持

用途:
- 安全日志存储
- 监控指标存储
- 事件时间线数据

**图数据库: ArangoDB**
- 多模型数据库（文档+图+键值）
- 高性能图查询
- 易于部署和维护
- 良好的扩展性

用途:
- 威胁关联分析
- 攻击路径重构
- 资产关系图谱

**缓存数据库: Redis**
- 高性能内存缓存
- 丰富的数据结构
- 发布/订阅功能

用途:
- 会话缓存
- 实时数据缓存
- 消息队列

### 5.3 大模型API集成方案

**多模型支持策略**:
- OpenAI GPT-4/GPT-3.5
- Anthropic Claude 3.5 Sonnet
- 本地开源模型（Llama、ChatGLM）

**模型调用管理**:
- 智能路由和负载均衡
- 成本优化和配额管理
- 结果缓存和重复利用
- 模型性能监控

**安全性考虑**:
- API密钥安全存储
- 数据脱敏和隐私保护
- 模型输出内容过滤
- 审计日志记录

### 5.4 安全认证和权限管理

**认证方式**:
- JWT（JSON Web Token）
- OAuth 2.0
- LDAP/Active Directory集成
- 多因素认证（MFA）

**权限模型**:
- 基于角色的访问控制（RBAC）
- 基于属性的访问控制（ABAC）
- 资源级权限控制
- 审计日志追踪

**安全措施**:
- API密钥管理
- 传输层加密（TLS）
- 数据库加密
- 敏感数据脱敏

## 6. 部署架构

### 6.1 容器化部署

**容器技术**:
- Docker容器化
- Kubernetes集群管理
- Helm Charts部署模板

**服务拆分**:
- 微服务架构
- 服务发现和注册
- 配置管理
- 健康检查

### 6.2 高可用设计

**可用性保障**:
- 多实例负载均衡
- 数据库主从复制
- 故障自动转移
- 监控告警系统

**扩展性设计**:
- 水平扩展支持
- 自动伸缩配置
- 资源限制和配额
- 性能监控优化
